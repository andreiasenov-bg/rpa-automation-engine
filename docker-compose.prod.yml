# Production Docker Compose overlay.
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

x-backend-prod-env: &prod-env
  ENVIRONMENT: production
  LOG_LEVEL: warning
  LOG_FORMAT: json
  UVICORN_WORKERS: "4"
  CELERY_CONCURRENCY: "8"
  # Override these via .env file or environment
  SECRET_KEY: ${SECRET_KEY:?Set SECRET_KEY in .env}
  ENCRYPTION_KEY: ${ENCRYPTION_KEY:?Set ENCRYPTION_KEY in .env}
  DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://rpa_user:rpa_secret_prod@postgres:5432/rpa_engine}
  REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
  CELERY_BROKER_URL: ${REDIS_URL:-redis://redis:6379/0}
  CELERY_RESULT_BACKEND: ${REDIS_URL:-redis://redis:6379/1}
  ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://rpa.example.com}

services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in .env}
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    restart: always

  redis:
    command: redis-server --requirepass ${REDIS_PASSWORD:-} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_prod_data:/data
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
    restart: always

  backend:
    environment:
      <<: *prod-env
      APP_ROLE: api
    command: >
      gunicorn app.main:app
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --workers ${UVICORN_WORKERS:-4}
      --timeout 120
      --graceful-timeout 30
      --keep-alive 5
      --access-logfile -
      --error-logfile -
    volumes: []  # No source mount in production
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
      replicas: 2
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery-worker:
    environment:
      <<: *prod-env
      APP_ROLE: worker
    command: >
      celery -A worker.celery_app worker
      --loglevel=warning
      --concurrency=${CELERY_CONCURRENCY:-8}
      --queues=default,workflows,triggers,notifications,health
      --hostname=worker@%h
      --max-tasks-per-child=1000
      --without-heartbeat
    volumes: []
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
      replicas: 2
    restart: always

  celery-beat:
    environment:
      <<: *prod-env
      APP_ROLE: beat
    command: >
      celery -A worker.celery_app beat
      --loglevel=warning
      --pidfile=/tmp/celerybeat.pid
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    restart: always

  frontend:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
      replicas: 2
    restart: always

volumes:
  postgres_prod_data:
  redis_prod_data:
