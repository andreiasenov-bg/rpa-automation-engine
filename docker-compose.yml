name: rpa-engine
x-backend-common:
  build: &id001
    context: ./backend
    dockerfile: Dockerfile
  environment:
    DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-rpa_user}:${POSTGRES_PASSWORD:-rpa_secret_dev}@pgbouncer:6432/${POSTGRES_DB:-rpa_engine}?prepared_statement_cache_size=0
    REDIS_URL: redis://redis:6379/0
    CELERY_BROKER_URL: redis://redis:6379/0
    CELERY_RESULT_BACKEND: redis://redis:6379/1
    SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
    ENCRYPTION_KEY: ${ENCRYPTION_KEY:-8C2qrXuG9jPsD6Pr_ZCa6Ud-LApiLta1j55MhbyOGS8=}
    ENVIRONMENT: development
    LOG_LEVEL: info
    LOG_FORMAT: colored
    ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
    DB_HOST: postgres
    DB_PORT: '5432'
    DB_USER: rpa_user
    REDIS_HOST: redis
    REDIS_PORT: '6379'
    ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@rpa-engine.com}
    ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD environment variable is required}
    PYTHONPATH: /app
  depends_on: &id002
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
    pgbouncer:
      condition: service_healthy
  volumes: &id003
  - ./backend:/app
services:
  postgres:
    image: postgres:16-alpine
    container_name: rpa-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-rpa_engine}
      POSTGRES_USER: ${POSTGRES_USER:-rpa_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rpa_secret_dev}
    ports:
    - 127.0.0.1:5432:5432
    volumes:
    - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U rpa_user -d rpa_engine
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    shm_size: 256mb
  redis:
    image: redis:7-alpine
    container_name: rpa-redis
    ports:
    - 127.0.0.1:6379:6379
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
  backend:
    build: *id001
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-rpa_user}:${POSTGRES_PASSWORD:-rpa_secret_dev}@pgbouncer:6432/${POSTGRES_DB:-rpa_engine}?prepared_statement_cache_size=0
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-8C2qrXuG9jPsD6Pr_ZCa6Ud-LApiLta1j55MhbyOGS8=}
      ENVIRONMENT: development
      LOG_LEVEL: info
      LOG_FORMAT: colored
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
      DB_HOST: postgres
      DB_PORT: '5432'
      DB_USER: rpa_user
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@rpa-engine.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD environment variable is required}
      APP_ROLE: api
      UVICORN_WORKERS: '1'
      CHAT_API_URL: ${CHAT_API_URL:-}
      CHAT_API_KEY: ${CHAT_API_KEY:-}
      CHAT_MODEL: ${CHAT_MODEL:-claude-sonnet-4-20250514}
      ANTHROPIC_API_KEY: ${CHAT_API_KEY:-}
      CLAUDE_MODEL: ${CHAT_MODEL:-claude-sonnet-4-20250514}
      PYTHONPATH: /app
    depends_on: *id002
    volumes: *id003
    container_name: rpa-backend
    ports:
    - 8000:8000
    command: 'uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --log-level
      info

      '
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/api/v1/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  celery-worker:
    build: *id001
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-rpa_user}:${POSTGRES_PASSWORD:-rpa_secret_dev}@pgbouncer:6432/${POSTGRES_DB:-rpa_engine}?prepared_statement_cache_size=0
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-8C2qrXuG9jPsD6Pr_ZCa6Ud-LApiLta1j55MhbyOGS8=}
      ENVIRONMENT: development
      LOG_LEVEL: info
      LOG_FORMAT: colored
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
      DB_HOST: postgres
      DB_PORT: '5432'
      DB_USER: rpa_user
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@rpa-engine.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD environment variable is required}
      APP_ROLE: worker
      CELERY_CONCURRENCY: '4'
      ANTHROPIC_API_KEY: ${CHAT_API_KEY:-}
      CLAUDE_MODEL: ${CHAT_MODEL:-claude-sonnet-4-20250514}
      PYTHONPATH: /app
    depends_on: *id002
    volumes: *id003
    container_name: rpa-celery-worker
    command: 'celery -A worker.celery_app worker --loglevel=info --concurrency=4 --queues=default,workflows,triggers,notifications,health
      --hostname=worker@%h

      '
    restart: unless-stopped
  celery-beat:
    build: *id001
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-rpa_user}:${POSTGRES_PASSWORD:-rpa_secret_dev}@pgbouncer:6432/${POSTGRES_DB:-rpa_engine}?prepared_statement_cache_size=0
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-8C2qrXuG9jPsD6Pr_ZCa6Ud-LApiLta1j55MhbyOGS8=}
      ENVIRONMENT: development
      LOG_LEVEL: info
      LOG_FORMAT: colored
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
      DB_HOST: postgres
      DB_PORT: '5432'
      DB_USER: rpa_user
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@rpa-engine.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD environment variable is required}
      APP_ROLE: beat
      PYTHONPATH: /app
    depends_on: *id002
    volumes: *id003
    container_name: rpa-celery-beat
    command: 'celery -A worker.celery_app beat --loglevel=info

      '
    restart: unless-stopped
  deployer:
    build:
      context: .
      dockerfile: scripts/Dockerfile.deployer
    container_name: rpa-deployer
    working_dir: /repo
    ports:
    - 9000:9000
    volumes:
    - .:/repo
    environment:
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      DEPLOY_TOKEN: ${DEPLOY_TOKEN:?DEPLOY_TOKEN environment variable is required}
    command: sh -c "apt-get update -qq && apt-get install -y -qq git curl >/dev/null
      2>&1 && python /repo/scripts/deployer.py"
    restart: unless-stopped
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rpa-frontend
    ports:
    - 3000:80
    depends_on:
    - backend
    restart: unless-stopped
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: rpa-pgbouncer
    ports:
    - 127.0.0.1:6432:6432
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-rpa_user}:${POSTGRES_PASSWORD:-rpa_secret_dev}@postgres:5432/${POSTGRES_DB:-rpa_engine}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: '200'
      DEFAULT_POOL_SIZE: '20'
      MIN_POOL_SIZE: '5'
      RESERVE_POOL_SIZE: '5'
      MAX_DB_CONNECTIONS: '50'
      IGNORE_STARTUP_PARAMETERS: extra_float_digits,search_path
      AUTH_TYPE: scram-sha-256
      ADMIN_USERS: rpa_user
      LISTEN_PORT: '6432'
      LOG_CONNECTIONS: '1'
      LOG_DISCONNECTIONS: '1'
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -h localhost -p 6432 -U rpa_user -d rpa_engine || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
  flower:
    image: mher/flower:2.0
    container_name: rpa-flower
    ports:
    - 127.0.0.1:5555:5555
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      FLOWER_BASIC_AUTH: ${ADMIN_EMAIL:-admin@rpa-engine.com}:${ADMIN_PASSWORD}
      FLOWER_URL_PREFIX: /flower
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    command: celery --broker=redis://redis:6379/0 flower --port=5555 --url_prefix=flower
volumes:
  postgres_data: null
  redis_data: null
  frontend_node_modules: null
