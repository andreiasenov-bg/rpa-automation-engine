services:
  backend:
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      LOG_FORMAT: json
  celery-worker:
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      LOG_FORMAT: json
      CELERY_CONCURRENCY: "4"
  celery-beat:
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      LOG_FORMAT: json
  frontend:
    command: sh -c "npm install --no-audit --no-fund 2>/dev/null; npm run build 2>&1; npx serve -s dist -l 3000"
    restart: unless-stopped
  deployer:
    restart: unless-stopped
    volumes:
      - .:/repo
      - /var/run/docker.sock:/var/run/docker.sock
    command: sh -c "apt-get update -qq && apt-get install -y -qq git curl docker.io >/dev/null 2>&1 && sh /repo/scripts/auto_deploy.sh & python /repo/scripts/deployer.py"
